<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Joy Bangla - Rajakar CDI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background: #000; touch-action: none; }
        canvas { display: block; }
        
        #crosshair {
            position: absolute;
            top: 50%; left: 50%;
            width: 24px; height: 24px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            display: none;
            z-index: 10;
            border: 2px solid rgba(255, 100, 100, 0.8);
            border-radius: 50%;
        }
        #crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 4px; height: 4px; background: #ff3333;
            transform: translate(-50%, -50%); border-radius: 50%;
        }
        
        #ui {
            position: absolute;
            top: 20px; left: 20px;
            display: none;
            z-index: 20;
            pointer-events: none;
        }

        #mobile-controls {
            position: absolute;
            bottom: 0; left: 0; width: 100%; height: 60vh;
            display: none; z-index: 30; pointer-events: none;
        }
        #joystick-container {
            position: absolute; bottom: 5vh; left: 5vw;
            width: 40vmin; height: 40vmin; max-width: 250px; max-height: 250px;
            background: rgba(255, 0, 0, 0.05);
            border: 2px solid rgba(255, 50, 50, 0.2);
            border-radius: 50%; pointer-events: auto; backdrop-filter: blur(2px);
        }
        #joystick-knob {
            position: absolute; top: 50%; left: 50%;
            width: 12vmin; height: 12vmin; max-width: 70px; max-height: 70px;
            background: #ff3333; border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #look-surface {
            position: absolute; top: 0; right: 0;
            width: 60%; height: 100%;
            pointer-events: auto; z-index: 25;
        }
        #shoot-button {
            position: absolute; bottom: 8vh; right: 8vw;
            width: 22vmin; height: 22vmin; max-width: 130px; max-height: 130px;
            background: rgba(255, 0, 0, 0.4); border: 3px solid rgba(255, 255, 255, 0.6); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; pointer-events: auto; font-size: 4vmin;
            backdrop-filter: blur(4px); user-select: none; z-index: 35;
            box-shadow: 0 0 20px rgba(255,0,0,0.3);
        }

        #overlay, #pause-menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(60,10,10,1) 0%, rgba(10,10,15,1) 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; text-align: center; overflow-y: auto; padding: 20px;
        }
        #pause-menu {
            background: rgba(0, 0, 0, 0.85);
            display: none;
        }

        .hit-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.5); pointer-events: none; display: none; z-index: 50;
        }
        .heal-flash {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 255, 50, 0.2); pointer-events: none; display: none; z-index: 50;
        }
    </style>
</head>
<body>

    <div id="hit-flash" class="hit-flash"></div>
    <div id="heal-flash" class="heal-flash"></div>

    <!-- Main Menu -->
    <div id="overlay">
        <h1 id="main-title" class="text-6xl font-black mb-2 text-white drop-shadow-lg uppercase tracking-tighter italic">Joy Bangla - Rajakar CDI</h1>
        <p id="sub-title" class="text-red-500 mb-6 font-bold tracking-widest uppercase">Developed by <a href='https://www.facebook.com/AntiBDAwamiLeagueABAL/'>Pro Awami Leaguer</a></p>
        
        <div class="bg-black/40 p-8 rounded-3xl shadow-2xl border-2 border-red-900/50 w-full max-w-md backdrop-blur-md">
            <p id="game-over-stats" class="mb-4 hidden text-3xl font-black text-red-500 uppercase"></p>
	<p id="sub-title" class="text-red-500 mb-6 font-bold tracking-widest uppercase">Select any mode to play:</p>
            <div class="flex flex-wrap gap-3 justify-center">
                <button onclick="startGame('easy')" class="bg-zinc-800 text-white border-b-4 border-green-600 flex-1 min-w-[100px] py-4 rounded-xl font-bold hover:bg-zinc-700 transition-colors shadow-lg">EASY</button>
                <button onclick="startGame('medium')" class="bg-zinc-800 text-white border-b-4 border-orange-500 flex-1 min-w-[100px] py-4 rounded-xl font-bold hover:bg-zinc-700 transition-colors shadow-lg">MEDIUM</button>
                <button onclick="startGame('hard')" class="bg-red-700 text-white border-b-4 border-red-900 flex-1 min-w-[100px] py-4 rounded-xl font-bold hover:bg-red-600 transition-colors shadow-lg">HARD</button>
            </div>
        </div>
    </div>

    <!-- Pause Menu -->
    <div id="pause-menu">
        <h2 class="text-5xl font-black mb-8 text-white uppercase tracking-tighter italic">Paused</h2>
        <div class="flex flex-col gap-4 w-full max-w-xs">
            <button onclick="resumeGame()" class="bg-red-600 text-white py-4 rounded-xl font-bold text-xl hover:bg-red-500 transition-colors shadow-lg border-b-4 border-red-900">RESUME</button>
            <button onclick="returnToMenu()" class="bg-zinc-800 text-white py-4 rounded-xl font-bold text-xl hover:bg-zinc-700 transition-colors shadow-lg border-b-4 border-zinc-950">MAIN MENU</button>
        </div>
    </div>

    <div id="ui">
        <div class="bg-black/90 p-5 rounded-2xl shadow-2xl border-2 border-red-600 text-white">
            <p class="text-[10px] font-black text-red-500 tracking-widest uppercase">Rajakars Cleared</p>
            <p class="text-5xl font-black leading-none mb-3" id="score">0</p>
            <div class="mt-2">
                <div class="flex justify-between text-[10px] font-bold mb-1">
                    <span class="text-red-400">INTEGRITY</span>
                    <span id="hp-text" class="text-red-400">100%</span>
                </div>
                <div class="w-48 h-3 bg-gray-900 rounded-full overflow-hidden border border-red-900/30">
                    <div id="health-bar" class="h-full bg-red-600 transition-all duration-75" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="crosshair"></div>

    <div id="mobile-controls">
        <div id="look-surface"></div>
        <div id="joystick-container"><div id="joystick-knob"></div></div>
        <div id="shoot-button">FIRE</div>
    </div>

    <script>
        let scene, camera, renderer, player, clock, gun, flashlight;
        let rajakars = [], healthPacks = [], bridges = [], colliders = [];
        let score = 0, health = 100;
        let isLocked = false, isMobile = false, isPaused = false, gameStarted = false;
        let yaw = 0, pitch = 0;
        let velocityY = 0;
        let isGrounded = true;
        const gravity = -25;
        const jumpForce = 10;
        
        let difficulty = 'medium';
        const keys = { w: false, a: false, s: false, d: false, " ": false };

        let joystickActive = false;
        let moveX = 0, moveY = 0;
        let lastTouchX = 0, lastTouchY = 0;
        let isTouchingLookSurface = false;

        const textureLoader = new THREE.TextureLoader();
        textureLoader.setCrossOrigin('anonymous');

        const headPhotos = [
            'golamazam.png',
            'kadermolla.png',
            'kamruzzaman.png',
            'mirkashem.png',
            'muzahid.png',
            'sakachowdhury.png',
            'sayeedi.png',
            'kadermolla.png',
            'golamazam.png',
            'sayeedi.png'
        ];

        const dressColors = [
            0x2c3e50, 0x4b4b4b, 0x1e272e, 0x3d3d3d, 0x2f3640, 
            0x2d3436, 0x192a56, 0x40739e, 0x27ae60, 0x7f8c8d,
            0x4834d4, 0x222f3e, 0x576574, 0x222222, 0x3b3b98
        ];

        function init() {
            isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0505); 
            scene.fog = new THREE.Fog(0x0a0505, 10, 120);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            const sun = new THREE.DirectionalLight(0xffdddd, 1.2);
            sun.position.set(50, 100, 50);
            sun.castShadow = true;
            scene.add(sun);

            scene.add(new THREE.AmbientLight(0x604040, 0.8));

            const floor = new THREE.Mesh(new THREE.PlaneGeometry(1000, 1000), new THREE.MeshStandardMaterial({ color: 0x1a1a1a }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            player = new THREE.Group();
            player.position.set(10, 1.7, 10); 
            scene.add(player);

            const gunGeom = new THREE.BoxGeometry(0.12, 0.12, 0.7);
            gun = new THREE.Mesh(gunGeom, new THREE.MeshStandardMaterial({ color: 0x333333 }));
            gun.position.set(0.35, -0.4, -0.6);
            camera.add(gun);

            flashlight = new THREE.SpotLight(0xffffff, 1.5, 40, Math.PI/6, 0.5, 1);
            flashlight.position.set(0, 0, 0);
            flashlight.target.position.set(0, 0, -1);
            camera.add(flashlight);
            camera.add(flashlight.target);

            scene.add(camera);
            createWorld();
            clock = new THREE.Clock();
            initControls();
            
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        function createWorld() {
            const river = new THREE.Mesh(
                new THREE.PlaneGeometry(30, 1000), 
                new THREE.MeshStandardMaterial({ color: 0x220505, transparent: true, opacity: 0.8 })
            );
            river.rotation.x = -Math.PI / 2;
            river.position.y = 0.05;
            river.position.x = -50; 
            scene.add(river);

            for (let z = -200; z <= 200; z += 100) {
                const deck = new THREE.Mesh(new THREE.BoxGeometry(35, 0.5, 10), new THREE.MeshStandardMaterial({color: 0x332222}));
                deck.position.set(-50, 0.3, z);
                scene.add(deck);
                bridges.push(deck);
            }

            for(let i=0; i<60; i++) {
                const tree = new THREE.Group();
                const trunk = new THREE.Mesh(new THREE.CylinderGeometry(0.4, 0.6, 6), new THREE.MeshStandardMaterial({color: 0x2a1d1d}));
                const leaves = new THREE.Mesh(new THREE.SphereGeometry(2.5, 6, 6), new THREE.MeshStandardMaterial({color: 0x331515}));
                leaves.position.y = 4;
                tree.add(trunk); tree.add(leaves);
                let tx = (Math.random()-0.5)*200;
                if(tx > -65 && tx < -35) tx += 40; 
                tree.position.set(tx, 3, (Math.random()-0.5)*200);
                scene.add(tree);
                colliders.push({ isRound: true, radius: 0.6, pos: tree.position });
            }
        }

        function spawnRajakar() {
            if (health <= 0 || !gameStarted || isPaused) return;
            const group = new THREE.Group();
            
            const randomPhoto = headPhotos[Math.floor(Math.random() * headPhotos.length)];
            const randomOutfitColor = dressColors[Math.floor(Math.random() * dressColors.length)];
            const limbColor = new THREE.Color(randomOutfitColor).multiplyScalar(0.7);
            const limbMat = new THREE.MeshStandardMaterial({ color: limbColor });
            
            // Head
            const headGeom = new THREE.BoxGeometry(0.7, 0.7, 0.7);
            const sideMat = new THREE.MeshStandardMaterial({ color: 0x223322 });
            const faceMat = new THREE.MeshStandardMaterial({ color: 0x445544 }); 
            const headMats = [sideMat, sideMat, sideMat, sideMat, faceMat, sideMat];
            const head = new THREE.Mesh(headGeom, headMats);
            head.position.y = 1.9;
            head.userData.isHead = true;
            group.add(head);

            textureLoader.load(randomPhoto, (tex) => {
                head.material[4] = new THREE.MeshStandardMaterial({ map: tex });
                head.material[4].needsUpdate = true;
            });

            // Body
            const body = new THREE.Mesh(new THREE.BoxGeometry(0.7, 1.1, 0.4), new THREE.MeshStandardMaterial({color: randomOutfitColor}));
            body.position.y = 1.0; 
            group.add(body);

            // Legs
            const legL = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), limbMat);
            const legR = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.25), limbMat);
            legL.position.set(-0.2, 0.4, 0); 
            legR.position.set(0.2, 0.4, 0);
            // Pivot at top of legs
            legL.geometry.translate(0, -0.4, 0); legL.position.y = 0.8;
            legR.geometry.translate(0, -0.4, 0); legR.position.y = 0.8;
            group.add(legL); group.add(legR);

            // Arms
            const armL = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.8, 0.2), limbMat);
            const armR = new THREE.Mesh(new THREE.BoxGeometry(0.2, 0.8, 0.2), limbMat);
            armL.position.set(-0.45, 1.4, 0);
            armR.position.set(0.45, 1.4, 0);
            // Pivot at shoulder
            armL.geometry.translate(0, -0.4, 0);
            armR.geometry.translate(0, -0.4, 0);
            group.add(armL); group.add(armR);

            const ang = Math.random() * Math.PI * 2;
            group.position.set(player.position.x + Math.cos(ang)*45, 0, player.position.z + Math.sin(ang)*45);
            
            group.userData = { legL, legR, armL, armR, animOffset: Math.random() * 10 };
            rajakars.push(group); 
            scene.add(group);
        }

        function spawnHealthPack(pos) {
            const group = new THREE.Group();
            const box = new THREE.Mesh(new THREE.BoxGeometry(1.2, 1.2, 1.2), new THREE.MeshStandardMaterial({ color: 0x333333, emissive: 0x112211 }));
            const crossMat = new THREE.MeshStandardMaterial({ color: 0x00ff00, emissive: 0x00ff00 });
            const cross1 = new THREE.Mesh(new THREE.BoxGeometry(0.8, 0.25, 0.1), crossMat);
            const cross2 = new THREE.Mesh(new THREE.BoxGeometry(0.25, 0.8, 0.1), crossMat);
            cross1.position.z = 0.61; cross2.position.z = 0.61;
            
            const glow = new THREE.PointLight(0x00ff00, 2, 10);
            group.add(glow); group.add(box); group.add(cross1); group.add(cross2);
            group.position.set(pos.x, 1.0, pos.z);
            scene.add(group);
            healthPacks.push(group);
        }

        function checkCollision(targetPos) {
            const pX = targetPos.x;
            const pZ = targetPos.z;
            const inRiverZone = pX > -65 && pX < -35;
            let onBridge = false;
            for(let b of bridges) {
                const bBox = new THREE.Box3().setFromObject(b).expandByScalar(0.2);
                if(bBox.containsPoint(new THREE.Vector3(pX, 0.3, pZ))) { onBridge = true; break; }
            }
            if (inRiverZone && !onBridge) return true;

            for (let obj of colliders) {
                const dist = Math.sqrt(Math.pow(pX - obj.pos.x, 2) + Math.pow(pZ - obj.pos.z, 2));
                if (dist < obj.radius + 0.8) return true;
            }
            return false;
        }

        function animate() {
            requestAnimationFrame(animate);
            if(!gameStarted || isPaused) { renderer.render(scene, camera); return; }
            
            const dt = Math.min(clock.getDelta(), 0.1);
            const time = clock.getElapsedTime();
            
            const dir = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);
            const side = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0,1,0), yaw);

            let moveVec = new THREE.Vector3(0,0,0);
            const moveSpeed = 14 * dt;
            if(keys.w) moveVec.add(dir.clone().multiplyScalar(moveSpeed));
            if(keys.s) moveVec.add(dir.clone().multiplyScalar(-moveSpeed));
            if(keys.a) moveVec.add(side.clone().multiplyScalar(-moveSpeed));
            if(keys.d) moveVec.add(side.clone().multiplyScalar(moveSpeed));

            if(joystickActive) {
                moveVec.add(dir.clone().multiplyScalar(-moveY * moveSpeed));
                moveVec.add(side.clone().multiplyScalar(moveX * moveSpeed));
            }

            const nextX = player.position.x + moveVec.x;
            const nextZ = player.position.z + moveVec.z;
            if (!checkCollision({x: nextX, z: nextZ})) { player.position.x = nextX; player.position.z = nextZ; }

            velocityY += gravity * dt;
            player.position.y += velocityY * dt;
            let groundY = 1.7;
            for(let b of bridges) {
                const bBox = new THREE.Box3().setFromObject(b).expandByScalar(0.2);
                if(bBox.containsPoint(new THREE.Vector3(player.position.x, 0.3, player.position.z))) { groundY = bBox.max.y + 1.7; break; }
            }
            if(player.position.y < groundY) { player.position.y = groundY; velocityY = 0; isGrounded = true; }

            camera.position.copy(player.position);
            camera.rotation.set(pitch, yaw, 0, 'YXZ');
            gun.position.z = THREE.MathUtils.lerp(gun.position.z, -0.6, 0.1);

            healthPacks.forEach((hp, i) => {
                hp.rotation.y += 2 * dt;
                if(hp.position.distanceTo(player.position) < 2.5) {
                    health = Math.min(100, health + 25); updateHealthUI();
                    scene.remove(hp); healthPacks.splice(i, 1);
                    document.getElementById('heal-flash').style.display = 'block';
                    setTimeout(() => { document.getElementById('heal-flash').style.display = 'none'; }, 150);
                }
            });

            rajakars.forEach((z) => {
                const toP = new THREE.Vector3().subVectors(player.position, z.position);
                toP.y = 0;
                const dist = toP.length();
                const zSpeed = (difficulty === 'easy' ? 4.5 : difficulty === 'medium' ? 8 : 12.5) * dt;
                z.position.add(toP.normalize().multiplyScalar(zSpeed));
                z.lookAt(player.position.x, 0, player.position.z);

                // Complex Walking Animation
                const animSpeed = 10;
                const walkCycle = Math.sin(time * animSpeed + z.userData.animOffset);
                const armCycle = Math.cos(time * animSpeed + z.userData.animOffset);
                
                // Legs move back and forth
                z.userData.legL.rotation.x = walkCycle * 0.6;
                z.userData.legR.rotation.x = -walkCycle * 0.6;
                
                // Arms move back and forth (opposite of legs)
                // Also raised slightly in front like a classic rajakar
                z.userData.armL.rotation.x = -1.2 + armCycle * 0.4;
                z.userData.armR.rotation.x = -1.2 - armCycle * 0.4;
                
                // Subtle shoulder swaying
                z.userData.armL.rotation.z = -0.1 + walkCycle * 0.05;
                z.userData.armR.rotation.z = 0.1 + walkCycle * 0.05;

                if(dist < 2.2) {
                    health -= 65 * dt; updateHealthUI();
                    document.getElementById('hit-flash').style.display = 'block';
                    setTimeout(() => { document.getElementById('hit-flash').style.display = 'none'; }, 50);
                    if(health <= 0) gameOver();
                }
            });
            renderer.render(scene, camera);
        }

        function shoot() {
            if (health <= 0 || !gameStarted || isPaused) return;
            gun.position.z = -0.3;
            const ray = new THREE.Raycaster();
            ray.setFromCamera(new THREE.Vector2(0, 0), camera);
            const allHeads = [];
            rajakars.forEach(z => { z.children.forEach(c => { if(c.userData.isHead) allHeads.push(c); }); });
            const intersects = ray.intersectObjects(allHeads);
            if(intersects.length > 0) {
                let rajakarGroup = intersects[0].object.parent;
                const pos = rajakarGroup.position.clone();
                scene.remove(rajakarGroup); 
                rajakars = rajakars.filter(z => z !== rajakarGroup);
                score++; document.getElementById('score').innerText = score;
                if(Math.random() < 0.25) spawnHealthPack(pos);
            }
        }

        function startGame(lvl) {
            difficulty = lvl;
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            document.getElementById('crosshair').style.display = 'block';
            score = 0; health = 100;
            document.getElementById('score').innerText = '0';
            updateHealthUI();
            rajakars.forEach(z => scene.remove(z)); rajakars = []; 
            healthPacks.forEach(hp => scene.remove(hp)); healthPacks = [];
            player.position.set(10, 1.7, 10);
            gameStarted = true; isPaused = false;
            if(!isMobile) renderer.domElement.requestPointerLock(); else isLocked = true;
            if(window.spawnInterval) clearInterval(window.spawnInterval);
            const rate = lvl === 'easy' ? 2200 : lvl === 'medium' ? 1400 : 900;
            window.spawnInterval = setInterval(spawnRajakar, rate);
            if(!window.animating) { animate(); window.animating = true; }
        }

        function pauseGame() {
            if (!gameStarted || health <= 0) return;
            isPaused = true;
            document.getElementById('pause-menu').style.display = 'flex';
            document.getElementById('crosshair').style.display = 'none';
            if (document.pointerLockElement === renderer.domElement) document.exitPointerLock();
        }

        function resumeGame() {
            isPaused = false;
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('crosshair').style.display = 'block';
            if (!isMobile) renderer.domElement.requestPointerLock();
        }

        function returnToMenu() {
            gameStarted = false; isPaused = false; isLocked = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('pause-menu').style.display = 'none';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
            clearInterval(window.spawnInterval);
            rajakars.forEach(z => scene.remove(z)); rajakars = [];
            healthPacks.forEach(hp => scene.remove(hp)); healthPacks = [];
        }

        function updateHealthUI() {
            document.getElementById('health-bar').style.width = Math.max(0, health) + "%";
            document.getElementById('hp-text').innerText = Math.round(Math.max(0, health)) + "%";
        }

        function initControls() {
            document.addEventListener('pointerlockchange', () => {
                isLocked = document.pointerLockElement === renderer.domElement;
                if (!isLocked && gameStarted && !isPaused && !isMobile) pauseGame();
            });
            renderer.domElement.addEventListener('mousedown', () => {
                if(gameStarted && !isPaused) {
                    if(!isLocked && !isMobile) renderer.domElement.requestPointerLock();
                    else shoot();
                }
            });
            window.addEventListener('keydown', (e) => { 
                keys[e.key.toLowerCase()] = true; 
                if (e.key === " " && isGrounded && gameStarted && !isPaused) { velocityY = jumpForce; isGrounded = false; }
                if (e.key === "Escape") { if (isPaused) resumeGame(); else if (gameStarted) pauseGame(); }
            });
            window.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });
            document.addEventListener('mousemove', (e) => {
                if (isLocked && !isPaused) { yaw -= e.movementX * 0.003; pitch -= e.movementY * 0.003; pitch = Math.max(-1.5, Math.min(1.5, pitch)); }
            });

            if (isMobile) {
                document.getElementById('mobile-controls').style.display = 'block';
                const joystick = document.getElementById('joystick-container');
                const knob = document.getElementById('joystick-knob');
                const lookSurface = document.getElementById('look-surface');

                joystick.addEventListener('touchstart', (e) => { if(!isPaused) joystickActive = true; e.preventDefault(); }, {passive: false});
                lookSurface.addEventListener('touchstart', (e) => {
                    if(!isPaused) { isTouchingLookSurface = true; lastTouchX = e.touches[0].clientX; lastTouchY = e.touches[0].clientY; }
                    e.preventDefault();
                }, {passive: false});

                window.addEventListener('touchmove', (e) => {
                    if (isPaused) return;
                    for(let touch of e.changedTouches) {
                        const jRect = joystick.getBoundingClientRect();
                        if(joystickActive && touch.clientX < window.innerWidth / 2) {
                            const centerX = jRect.left + jRect.width / 2, centerY = jRect.top + jRect.height / 2;
                            let dx = touch.clientX - centerX, dy = touch.clientY - centerY;
                            const maxDist = jRect.width / 2;
                            const dist = Math.sqrt(dx*dx + dy*dy);
                            if(dist > maxDist) { dx *= maxDist / dist; dy *= maxDist / dist; }
                            knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                            moveX = dx / maxDist; moveY = dy / maxDist;
                        }
                        if(isTouchingLookSurface && touch.clientX > window.innerWidth / 3) {
                            const dx = touch.clientX - lastTouchX, dy = touch.clientY - lastTouchY;
                            yaw -= dx * 0.005; pitch -= dy * 0.005; pitch = Math.max(-1.5, Math.min(1.5, pitch));
                            lastTouchX = touch.clientX; lastTouchY = touch.clientY;
                        }
                    }
                }, {passive: false});

                window.addEventListener('touchend', (e) => { 
                    if(e.touches.length === 0) { joystickActive = false; isTouchingLookSurface = false; moveX = 0; moveY = 0; knob.style.transform = 'translate(-50%, -50%)'; }
                });

                document.getElementById('shoot-button').addEventListener('touchstart', (e) => { shoot(); e.preventDefault(); }, {passive: false});
            }
        }

        function gameOver() { 
            health = 0; gameStarted = false; isLocked = false;
            document.getElementById('overlay').style.display = 'flex';
            document.getElementById('main-title').innerText = "We are Pro-71";
            document.getElementById('game-over-stats').innerText = `Total Rajakar Killed: ${score}`;
            document.getElementById('game-over-stats').style.display = 'block';
            document.getElementById('ui').style.display = 'none';
            document.getElementById('crosshair').style.display = 'none';
            clearInterval(window.spawnInterval);
            if (document.pointerLockElement === renderer.domElement) document.exitPointerLock();
        }
        init();
    </script>
</body>

</html>
